----- Máquinas do IME -----
192.168.91.59
192.168.91.61
192.168.91.180 (Servidor NFS)


----- NFS client -----
1) sudo apt-get install nfs-common 
2) sudo mount -t nfs -o proto=tcp,port=2049 192.168.91.180:/ /home/pedro/pfc/


----- Instalando o libvirt -----
1) Copiar pasta libvirt-0.9.8 de um dos outros computadores (scp)
2) apt-get install libpciaccess-dev && apt-get install libdevmapper-dev && apt-get install libxml2-dev && apt-get install libnl-dev && apt-get install libgnutls-dev
3) ./configure --prefix=/usr/ --localstatedir=/var/ --sysconfdir=/etc/
4) make
5) sudo make install
6) editar o arquivo /etc/hosts e adicionar 'ip   hostname' de todas as máquinas físicas
7) editar /etc/libvirt/libvirt.conf e descomentar:
    7.1) listen_tls = 0
    7.2) listen_tcp = 1


----- Usar libvirt como non root -----
1) Disable apparmor
sudo /etc/init.d/apparmor stop
sudo /etc/init.d/apparmor teardown
sudo update-rc.d -f apparmor remove

2) Setup polkit
vi /etc/polkit-1/localauthority/50-local.d/org.libvirt.unix.manage.pkla
[Allow pedro libvirt management permissions]
Identity=unix-user:pedro
Action=org.libvirt.unix.manage
ResultAny=yes
ResultInactive=yes
ResultActive=yes


----- Gerenciamento de máquinas virtuais -----
virsh list: máquinas ativas
virsh list --all: todas as máquinas
virsh destroy <mv>: desliga a MV
virsh undefine <mv>: remove a MV*
virsh start <mv>: inicia a MV
virsh console <mv>: conecta-se ao console da MV

*: ao usar virsh undefine em uma MV ativa, ela continuará rodando até ser desligada.


----- Criar discos virtuais -----

1)dd if=/dev/zero of=/home/pedro/pfc/export/<mv>.img bs=1000 count=0 seek=$[1024*1024*N]
onde N é o tamanho do disco em GB

2) sudo chmod o+w /home/pedro/pfc/export/<mv>.img


----- Criar máquinas virtuais -----

1) Há duas possibilidades:
    1.1) Se o disco utilizado for novo:
    virt-install --connect=qemu:///system \
        --network bridge=virbr0 \
        --extra-args="text console=tty0 utf8 console=ttyS0,115200" \
        --name=<mv> \
        --disk path=/home/pedro/pfc/export/<mv>.img,bus=virtio,cache=none \
        --vcpus=1 \
        --ram=512 \
        --check-cpu \
        --accelerate \
        --hvm \
        --location=/home/pedro/CentOS-6.4-i386-bin-DVD1.iso \
        --nographics

    1.2) Caso o disco já tenha um SO instalado:
    virt-install --connect=qemu:///system \
        --network bridge=virbr0 \
        --name=<mv> \
        --disk path=pfc/export/<mv>.img,bus=virtio,cache=none \
        --vcpus=1 \
        --ram=512 \
        --check-cpu \
        --accelerate \
        --hvm \
        --import

2) virsh edit <mv>
Certificar-se que a linha abaixo tem o parâmetro machine com valor pc-0.14
<type arch='i686' machine='pc-0.14'>hvm</type>


----- Comando de migração -----
virsh migrate --live centos59_2 qemu+ssh://192.168.91.61/system --verbose --persistent --undefinesource

